---
- name: Add new bastion user and remove its shell
  ansible.builtin.user:
    name: "{{ bastion_username }}"
    state: present
    shell: /usr/sbin/nologin

- name: Update and Upgrade apt cache and packages
  ansible.builtin.apt:
    name: "*"
    state: latest
    update_cache: yes

- name: Remove snap
  ansible.builtin.apt:
    name: snapd
    state: absent
    autoremove: yes
    purge: yes

## Debating whether to do this or copy keys from root user
# - name: Copy ssh public key
#   ansible.posix.authorized_key:
#     user: "{{ username }}"
#     key: "{{ lookup('file', ssh_key_path) }}"
#     state: present
#   when: ssh_copy_key | bool

- name: Ensure user's SSH dir exists
  ansible.builtin.file:
    path: "/home/{{ bastion_username }}/.ssh"
    state: directory
    owner: "{{ bastion_username }}"
    group: "{{ bastion_username }}"
    mode: 0755

- name: Copy SSH key from root user
  ansible.builtin.copy:
    dest: "/home/{{ bastion_username }}/.ssh/authorized_keys"
    src: /root/.ssh/authorized_keys
    remote_src: yes
    owner: "{{ bastion_username }}"
    group: "{{ bastion_username }}"
    mode: 0644

- name: Secure SSH
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    state: present
    validate: 'sshd -t -f %s'
  loop:
    - regexp: "^PasswordAuthentication"
      line: "PasswordAuthentication no"

    - regexp: "^PermitRootLogin"
      line: "PermitRootLogin no"

    - regexp: "^AllowUsers"
      line: "AllowUsers {{ bastion_username }}"

    - regexp: "^AuthenticationMethods"
      line: "AuthenticationMethods publickey"

    - regexp: "^ForceCommand"
      line: "ForceCommand /usr/sbin/nologin"

    - regexp: "^PermitTTY"
      line: "PermitTTY no"

    - regexp: "^X11Forwarding"
      line: "X11Forwarding no"

    - regexp: "^PermitTunnel"
      line: "PermitTunnel no"

    - regexp: "^GatewayPorts"
      line: "GatewayPorts no"

    - regexp: "^AllowAgentForwarding"
      line: "AllowAgentForwarding no"

    - regexp: "^AllowStreamLocalForwarding"
      line: "AllowStreamLocalForwarding no"
  notify: restart sshd
