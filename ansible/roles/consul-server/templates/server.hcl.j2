#### General
node_name   = "{{ consul_node_name }}"
client_addr = "0.0.0.0"
server      = true

#### Connection
# only allow https
ports {
  http  = -1
  https = 8501
  grpc  = 8502
}

# join the other server nodes
retry_join = [
{% for host in groups['servers'] %}
{% if host != inventory_hostname %}
{% if hostvars[host]['ansible_host'] is defined %}
  {{ hostvars[host]['ansible_host'] }},
{% else %}
  {{ host }},
{% endif %}
{% endif %}
{% endfor %}
]
bootstrap_expect = {{ consul_server_count }}

ui_config {
  enabled = true
}

#### Security
encrypt = "{{ consul_gossip_encrypt_key }}"

tls {
  defaults {
    key_file        = "{{ consul_certs_dir }}/server_tls_key.pem"
    cert_file       = "{{ consul_certs_dir }}/server_tls_cert.pem"
    ca_file         = "{{ consul_certs_dir }}/ca_cert.pem"
    verify_incoming = true
    verify_outgoing = true
  }

  internal_rpc {
    verify_server_hostname = true
  }
}

acl {
  enabled                  = true
  default_policy           = "deny"
  enable_token_persistence = true

  tokens {
    initial_management = "{{ consul_acl_bootstrap_token }}"
    default            = "{{ consul_acl_bootstrap_token }}"
  }
}

## Connect Service Mesh
connect {
  enabled = true
#   ca_provider = "consul"
#   ca_config {
#     # ...
#   }
}
